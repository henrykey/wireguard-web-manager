<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WireGuard Manager</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .container { max-width: 1200px; }
        .nav-tabs { margin-bottom: 15px; }
        .status-pill {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>WireGuard Manager</h1>

        <!-- Toggle Server Config Button -->
        <button class="btn btn-secondary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#serverConfigSection" aria-expanded="false" aria-controls="serverConfigSection">
            <i class="bi bi-gear"></i> Show/Hide Server Configuration
        </button>

        <!-- Server Config Section (Collapsible) -->
        <div class="collapse" id="serverConfigSection">
            <div class="card mb-4" id="serverConfigCard">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>Server Configuration</div>
                    {% if server_status %}
                    <div class="text-{{ server_status.status }} small">
                        <span class="status-pill bg-{{ server_status.status }}"></span>
                        {{ server_status.message }}
                    </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if not has_server_conf %}
                    <form method="post">
                        <input type="hidden" name="action" value="create_server_conf">
                        <div class="mb-3">
                            <label class="form-label">Config Filename</label>
                            <input type="text" class="form-control" name="filename" value="wg0.conf" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Config Content</label>
                            <textarea class="form-control" name="conf_content" id="conf_content" rows="12" required>{{ default_conf }}</textarea>
                        </div>
                        <button type="button" class="btn btn-secondary mb-2" id="gen-key-btn">Generate PrivateKey</button>
                        <button type="submit" class="btn btn-primary">Save Config</button>
                    </form>
                    <script>
                    document.getElementById('gen-key-btn').onclick = function() {
                        fetch('{{ url_for("gen_server_key") }}')
                            .then(resp => resp.json())
                            .then(data => {
                                let textarea = document.getElementById('conf_content');
                                textarea.value = textarea.value.replace(/PrivateKey\s*=\s*.*/g, 'PrivateKey = ' + data.private_key);
                            });
                    };
                    </script>
                    {% else %}
                    <form method="get" id="select-server-form">
                        <div class="mb-3">
                            <label class="form-label">Select Interface Config</label>
                            <div class="input-group">
                                <select class="form-select" name="edit_conf" id="edit_conf">
                                    {% for conf in server_configs %}
                                    <option value="{{ conf }}" {% if selected_conf == conf %}selected{% endif %}>{{ conf }}</option>
                                    {% endfor %}
                                    <option value="add_new" {% if selected_conf == 'add_new' %}selected{% endif %}>+ Add New Interface</option>
                                </select>
                                <button class="btn btn-outline-secondary" type="submit">Select</button>
                            </div>
                        </div>
                    </form>

                    <!-- Add New Interface Form (Initially Hidden) -->
                    <div id="new-interface-form" style="display: {% if selected_conf == 'add_new' %}block{% else %}none{% endif %};">
                        <form method="post">
                            <input type="hidden" name="action" value="create_server_conf">
                            <div class="mb-3">
                                <label class="form-label">New Interface Filename</label>
                                <input type="text" class="form-control" name="filename" placeholder="e.g. wg1.conf" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Config Content</label>
                                <textarea class="form-control" name="conf_content" id="new_conf_content" rows="12" required>{{ default_conf }}</textarea>
                            </div>
                            <button type="button" class="btn btn-secondary mb-2" id="gen-key-btn-new">Generate PrivateKey</button>
                            <button type="submit" class="btn btn-primary">Create Interface</button>
                        </form>
                    </div>

                    <!-- Edit Existing Interface Form -->
                    <div id="edit-interface-form" style="display: {% if selected_conf and selected_conf != 'add_new' %}block{% else %}none{% endif %};">
                        <form method="post" id="server-form">
                            <input type="hidden" name="action" id="form-action" value="{{ form_action }}">
                            <input type="hidden" name="filename" value="{{ selected_conf }}">
                            <div class="mb-3">
                                <label class="form-label">{% if selected_conf == 'add_new' %}New Interface Name{% else %}Edit Config Content{% endif %}</label>
                                {% if selected_conf == 'add_new' %}
                                <input type="text" class="form-control mb-3" name="filename" placeholder="e.g. wg1.conf" required>
                                {% endif %}
                                <textarea class="form-control" name="conf_content" id="edit_conf_content" rows="12" required>{{ edit_conf_content }}</textarea>
                            </div>
                            <button type="button" class="btn btn-secondary mb-2" id="gen-key-btn-edit">Generate PrivateKey</button>
                            <button type="button" class="btn btn-primary" onclick="submitForm('{{ form_action }}')">
                                {% if selected_conf == 'add_new' %}Create Interface{% else %}Save Changes{% endif %}
                            </button>
                            {% if selected_conf != 'add_new' %}
                            <button type="button" class="btn btn-success ms-2" onclick="submitForm('start_server')">Start Interface</button>
                            <button type="button" class="btn btn-warning ms-2" onclick="submitForm('restart_server')">Restart Interface</button>
                            {% endif %}
                        </form>
                    </div>

                    <script>
                    document.getElementById('edit_conf').onchange = function() {
                        if(this.value === 'add_new') {
                            document.getElementById('new-interface-form').style.display = 'block';
                            document.getElementById('edit-interface-form').style.display = 'none';
                        } else {
                            document.getElementById('select-server-form').submit();
                        }
                    };

                    document.getElementById('gen-key-btn-new').onclick = function() {
                        fetch('{{ url_for("gen_server_key") }}')
                            .then(resp => resp.json())
                            .then(data => {
                                let textarea = document.getElementById('new_conf_content');
                                textarea.value = textarea.value.replace(/PrivateKey\s*=\s*.*/g, 'PrivateKey = ' + data.private_key);
                            });
                    };

                    document.getElementById('gen-key-btn-edit').onclick = function() {
                        fetch('{{ url_for("gen_server_key") }}')
                            .then(resp => resp.json())
                            .then(data => {
                                let textarea = document.getElementById('edit_conf_content');
                                textarea.value = textarea.value.replace(/PrivateKey\s*=\s*.*/g, 'PrivateKey = ' + data.private_key);
                            });
                    };

                    function submitForm(action) {
                        document.getElementById('form-action').value = action;
                        document.getElementById('server-form').submit();
                    }
                    </script>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Add New Client Form -->
        <div class="card mb-4">
            <div class="card-header">Add New Client</div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('index') }}">
                    <div class="mb-3">
                      <label for="name" class="form-label">Client Name</label>
                      <input type="text" class="form-control" name="name" id="name" required>
                    </div>
                    <div class="mb-3">
                      <label for="interface" class="form-label">WireGuard Interface</label>
                      <select class="form-select" name="interface" id="interface" onchange="switchInterface(this.value)">
                        {% for iface in interfaces %}
                          <option value="{{ iface }}" {% if selected_interface == iface %}selected{% endif %}>{{ iface }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="mb-3">
                      <label for="allowed_ips" class="form-label">Allowed IPs (optional)</label>
                      <input type="text" class="form-control" name="allowed_ips" id="allowed_ips" placeholder="e.g. 192.168.1.0/24">
                    </div>
                    <div class="mb-3">
                      <label for="ip_last_octet" class="form-label">Custom IP Last Octet (optional)</label>
                      <input type="number" class="form-control" name="ip_last_octet" id="ip_last_octet" placeholder="e.g. 7" min="2" max="254">
                    </div>
                    {% if endpoint_options %}
                    <div class="mb-3">
                      <label for="endpoint_select" class="form-label">Server Endpoint</label>
                      <select class="form-select" id="endpoint_select" name="selected_endpoint">
                        {% for ep in endpoint_options %}
                          {% if ep.startswith('auto:') %}
                            <option value="{{ ep[5:] }}">Auto ({{ ep[5:] }})</option>
                          {% elif ep.startswith('public:') %}
                            <option value="{{ ep[7:] }}">Public IP ({{ ep[7:] }})</option>
                          {% else %}
                            <option value="{{ ep }}">{{ ep }}</option>
                          {% endif %}
                        {% endfor %}
                        <option value="custom">Custom...</option>
                      </select>
                      <input type="text" class="form-control mt-2" name="custom_endpoint" id="custom_endpoint" placeholder="e.g. 1.2.3.4:51820" style="display:none;">
                    </div>
                    <script>
                    document.getElementById('endpoint_select').onchange = function() {
                        if(this.value === "custom") {
                            document.getElementById('custom_endpoint').style.display = '';
                        } else {
                            document.getElementById('custom_endpoint').style.display = 'none';
                        }
                    };
                    </script>
                    {% endif %}
                    <button type="submit" class="btn btn-primary">Generate Client Config</button>
                </form>
            </div>
        </div>

        <!-- Client List Tabs -->
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="clientTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="status-tab" data-bs-toggle="tab" data-bs-target="#status" type="button" role="tab" aria-controls="status" aria-selected="true">Status</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage" type="button" role="tab" aria-controls="manage" aria-selected="false">Manage</button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div>
                    Client List for <span class="badge bg-info">{{ selected_interface }}</span>
                  </div>
                  <div>
                    <form action="{{ url_for('sync_wg_clients') }}" method="POST">
                      <input type="hidden" name="current_interface" value="{{ selected_interface }}">
                      <button type="submit" class="btn btn-warning btn-sm">
                        Sync WireGuard Status
                      </button>
                    </form>
                  </div>
                </div>
                <div class="tab-content" id="clientTabsContent">
                    <!-- Status Tab -->
                    <div class="tab-pane fade show active" id="status" role="tabpanel" aria-labelledby="status-tab">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Endpoint IP</th>
                                    <th>TX / RX</th>
                                    <th>Last Handshake</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for client in clients %}
                                <tr {% if client.active %}class="table-success"{% endif %}>
                                    <td>{{ client.name }}</td>
                                    <td>{{ client.endpoint_ip }}</td>
                                    <td>↑ {{ client.tx }} / ↓ {{ client.rx }}</td>
                                    <td>{{ client.last_seen }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center">No clients found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <!-- Manage Tab -->
                    <div class="tab-pane fade" id="manage" role="tabpanel" aria-labelledby="manage-tab">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>WG IP</th>
                                    <th>Created At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for client in clients %}
                                <tr>
                                    <td>{{ client.name }}</td>
                                    <td>{{ client.wg_ip }}</td>
                                    <td>{{ client.created_at }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <!-- Modal trigger button -->
                                            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" 
                                                    data-bs-target="#renameModal{{ client.name|replace(' ', '_')|replace('.', '_')|replace('-', '_')|replace('/', '_') }}">
                                                Rename
                                            </button>
                                            <form action="{{ url_for('toggle_client', name=client.name) }}" method="POST" style="display: inline;">
                                                {% if client.active %}
                                                <input type="hidden" name="action" value="pause">
                                                <button type="submit" class="btn btn-outline-warning">Pause</button>
                                                {% else %}
                                                <input type="hidden" name="action" value="resume">
                                                <button type="submit" class="btn btn-outline-success">Resume</button>
                                                {% endif %}
                                            </form>
                                            <a href="{{ url_for('show_qr', name=client.name) }}" class="btn btn-outline-secondary">
                                                Show QR Code
                                            </a>
                                            <a href="{{ url_for('download', filename='wg' + client.name + '.conf') }}" class="btn btn-outline-info">
                                                Download Config
                                            </a>
                                            <form action="{{ url_for('delete_client', name=client.name) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this client?');" style="display: inline;">
                                                <button type="submit" class="btn btn-outline-danger">Delete</button>
                                            </form>
                                        </div>
                                        <!-- Rename Modal -->
                                        <div class="modal fade" id="renameModal{{ client.name|replace(' ', '_')|replace('.', '_')|replace('-', '_')|replace('/', '_') }}" tabindex="-1" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title">Rename Client</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <form action="{{ url_for('rename_client', old_name=client.name) }}" method="POST">
                                                        <div class="modal-body">
                                                            <div class="mb-3">
                                                                <label for="new_name" class="form-label">New Name</label>
                                                                <input type="text" class="form-control" id="new_name" name="new_name" required>
                                                            </div>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                            <button type="submit" class="btn btn-primary">Save</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center">No clients found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Keep tab after refresh
        const hash = window.location.hash;
        if (hash) {
            const tabTrigger = document.querySelector(`button[data-bs-target="${hash}"]`);
            if (tabTrigger) {
                new bootstrap.Tab(tabTrigger).show();
            }
        }

        // Server config section collapse state management
        document.addEventListener('DOMContentLoaded', function() {
            const serverConfigSection = document.getElementById('serverConfigSection');
            const showConfig = localStorage.getItem('showServerConfig') === 'true';
            
            if (showConfig) {
                serverConfigSection.classList.add('show');
            }
            
            // Save preference when toggled
            serverConfigSection.addEventListener('shown.bs.collapse', function() {
                localStorage.setItem('showServerConfig', 'true');
            });
            
            serverConfigSection.addEventListener('hidden.bs.collapse', function() {
                localStorage.setItem('showServerConfig', 'false');
            });
        });

        function switchInterface(interface) {
            // 创建表单用于提交
            const form = document.createElement('form');
            form.method = 'GET';
            form.action = '{{ url_for("index") }}';
            
            // 创建接口输入
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'interface';
            input.value = interface;
            
            // 添加输入到表单并提交
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }
    </script>
</body>
</html>
