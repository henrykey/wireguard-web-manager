<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WireGuard 管理器</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <style>
        .container { max-width: 1200px; }
        .nav-tabs { margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>WireGuard 管理器</h1>
        
        <!-- 添加新客户端表单 -->
        <div class="card mb-4">
            <div class="card-header">添加新客户端</div>
            <div class="card-body">
                <!-- 修复表单结构 -->
                <form method="POST" action="{{ url_for('index') }}">
                    <div class="mb-3">
                      <label for="name" class="form-label">客户端名称</label>
                      <input type="text" class="form-control" name="name" id="name" required>
                    </div>
            
                    <div class="mb-3">
                      <label for="interface" class="form-label">WireGuard 接口</label>
                      <select class="form-select" name="interface" id="interface">
                        {% for iface in interfaces %}
                          <option value="{{ iface }}" {% if selected_interface == iface %}selected{% endif %}>{{ iface }}</option>
                        {% endfor %}
                      </select>
                    </div>
            
                    <div class="mb-3">
                      <label for="allowed_ips" class="form-label">允许的 IPs（可选）</label>
                      <input type="text" class="form-control" name="allowed_ips" id="allowed_ips" placeholder="例如：192.168.1.0/24">
                    </div>
            
                    <div class="mb-3">
                      <label for="ip_last_octet" class="form-label">自定义 IP 最后一个八位组（可选）</label>
                      <input type="number" class="form-control" name="ip_last_octet" id="ip_last_octet" placeholder="例如：7" min="2" max="254">
                    </div>
            
                    <!-- 端点选择部分 -->
                    {% if endpoint_options %}
                    <div class="mb-3">
                      <label for="endpoint_select" class="form-label">服务器端点</label>
                      <select class="form-select" id="endpoint_select" name="selected_endpoint">
                        {% for ep in endpoint_options %}
                          <option value="{{ ep }}">{{ ep }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    {% endif %}
                    
                    <!-- 提交按钮 -->
                    <button type="submit" class="btn btn-primary">生成客户端配置</button>
                  </form>
            </div>
        </div>

        <!-- 客户端列表标签页 -->
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="clientTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="status-tab" data-bs-toggle="tab" data-bs-target="#status" type="button" role="tab" aria-controls="status" aria-selected="true">状态</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage" type="button" role="tab" aria-controls="manage" aria-selected="false">管理</button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <!-- 添加到客户端列表上方，例如在标签页导航下方 -->
                <div class="mb-3 mt-3">
                    <form action="{{ url_for('sync_wg_clients') }}" method="POST" style="display: inline;">
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-arrow-repeat"></i> 同步 WireGuard 状态
                        </button>
                    </form>
                </div>
                <div class="tab-content" id="clientTabsContent">
                    <!-- 状态标签页 -->
                    <div class="tab-pane fade show active" id="status" role="tabpanel" aria-labelledby="status-tab">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>名称</th>
                                    <th>Endpoint IP</th>
                                    <th>发送/接收</th>
                                    <th>最后连接</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for client in clients %}
                                <tr {% if client.active %}class="table-success"{% endif %}>
                                    <td>{{ client.name }}</td>
                                    <td>{{ client.endpoint_ip }}</td>
                                    <td>↑ {{ client.tx }} / ↓ {{ client.rx }}</td>
                                    <td>{{ client.last_seen }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center">没有找到客户端</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 管理标签页 -->
                    <div class="tab-pane fade" id="manage" role="tabpanel" aria-labelledby="manage-tab">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>名称</th>
                                    <th>WG IP</th>
                                    <th>创建时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for client in clients %}
                                <tr>
                                    <td>{{ client.name }}</td>
                                    <td>{{ client.wg_ip }}</td>
                                    <td>{{ client.created_at }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#renameModal{{ client.name }}">
                                                重命名
                                            </button>
                                            
                                            <form action="{{ url_for('toggle_client', name=client.name) }}" method="POST" style="display: inline;">
                                                {% if client.active %}
                                                <input type="hidden" name="action" value="pause">
                                                <button type="submit" class="btn btn-outline-warning">暂停</button>
                                                {% else %}
                                                <input type="hidden" name="action" value="resume">
                                                <button type="submit" class="btn btn-outline-success">恢复</button>
                                                {% endif %}
                                            </form>
                                            
                                            <a href="{{ url_for('show_qr', name=client.name) }}" class="btn btn-outline-secondary">
                                                显示二维码
                                            </a>
                                            
                                            <a href="{{ url_for('download', filename='wg' + client.name + '.conf') }}" class="btn btn-outline-info">
                                                下载配置
                                            </a>
                                            
                                            <form action="{{ url_for('delete_client', name=client.name) }}" method="POST" onsubmit="return confirm('确定要删除此客户端吗?');" style="display: inline;">
                                                <button type="submit" class="btn btn-outline-danger">删除</button>
                                            </form>
                                        </div>
                                        
                                        <!-- 重命名模态框 -->
                                        <div class="modal fade" id="renameModal{{ client.name }}" tabindex="-1" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title">重命名客户端</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <form action="{{ url_for('rename_client', old_name=client.name) }}" method="POST">
                                                        <div class="modal-body">
                                                            <div class="mb-3">
                                                                <label for="new_name" class="form-label">新名称</label>
                                                                <input type="text" class="form-control" id="new_name" name="new_name" required>
                                                            </div>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                                            <button type="submit" class="btn btn-primary">保存</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center">没有找到客户端</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 确保引入Bootstrap的JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>